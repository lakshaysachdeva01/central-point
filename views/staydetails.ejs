<%- include('header'), {seoDetails} %>

<% 
  // Function to extract video ID from YouTube URL
  function getYouTubeVideoId(url) {
    if (!url) return '';
    let videoId = '';
    if (url.includes('youtu.be/')) {
      videoId = url.split('youtu.be/')[1]?.split('?')[0];
    } else if (url.includes('youtube.com/watch')) {
      videoId = url.split('v=')[1]?.split('&')[0];
    } else if (url.includes('youtube.com/embed/')) {
      videoId = url.split('youtube.com/embed/')[1]?.split('?')[0];
    }
    return videoId;
  }

  // YouTube video URL from stay data
  const youtubeUrl = stay && stay.youtubeVideo ? stay.youtubeVideo : '';
  const videoId = getYouTubeVideoId(youtubeUrl);
  const hasYouTubeVideo = videoId && videoId !== '';
%>

<header class="header">
    <div class="video-fullscreen-wrap">
        <div class="video-fullscreen-video" data-overlay-dark="4">
            <% if (hasYouTubeVideo) { %>
                <!-- YouTube Video Embed -->
                <div class="youtube-video-container" id="youtube-stay-video">
                    <iframe 
                        id="youtube-stay-iframe"
                        class="youtube-banner-iframe"
                        src="https://www.youtube.com/embed/<%= videoId %>?autoplay=1&mute=1&loop=1&playlist=<%= videoId %>&controls=0&modestbranding=1&rel=0&showinfo=0&iv_load_policy=3&disablekb=1&fs=0&playsinline=1&enablejsapi=1&origin=<%= typeof baseUrl !== 'undefined' ? encodeURIComponent(baseUrl) : '' %>"
                        frameborder="0"
                        allow="autoplay; encrypted-media"
                        allowfullscreen="false"
                        title="<%= stay.title %>"
                        loading="eager">
                    </iframe>
                    <!-- Overlay to block all user interactions -->
                    <div class="youtube-video-overlay"></div>
                </div>
            <% } else if (stay && stay.bannerImage) { %>
                <!-- Fallback to banner image -->
                <div style="background-image: url('<%= stay.bannerImage %>'); background-size: cover; background-position: center; width: 100%; height: 100%;"></div>
            <% } %>
        </div>
        <div class="v-middle">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-8 col-md-12 text-center">
                        <% if (stay && stay.tagline) { %>
                            <h5><%= stay.tagline %></h5>
                        <% } %>
                        <% if (stay && stay.title) { %>
                            <h1><%= stay.title %></h1>
                        <% } %>
                        <div class="details"> 
                            <% if (stay && stay.stayDetails && stay.stayDetails.bedType) { %>
                                <span><i class="fa-thin fa-bed-front"></i><%= stay.stayDetails.bedType.split(' ')[0] %> Bed</span>
                            <% } %>
                            <% if (stay && stay.stayDetails && stay.stayDetails.roomSize) { %>
                                <span><i class="fa-thin fa-expand"></i><%= stay.stayDetails.roomSize.split(' ')[0] %> Sqm</span>
                            <% } %>
                            <% if (stay && stay.stayDetails && stay.stayDetails.bathroom) { %>
                                <span><i class="fa-thin fa-bath"></i>Bathroom</span>
                            <% } %>
                            <% if (stay && stay.stayDetails && stay.stayDetails.breakfast) { %>
                                <span><i class="fa-thin fa-mug-saucer"></i>Breakfast</span> 
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<style>
    .col-lg-7{
        position: sticky;
    top: 125px;
    align-self: self-start;

    }
</style>

<% if (hasYouTubeVideo) { %>
<script>
  // Load YouTube IFrame API
  var tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName('script')[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  var ytStayPlayer;
  
  function onYouTubeIframeAPIReady() {
    ytStayPlayer = new YT.Player('youtube-stay-iframe', {
      events: {
        'onReady': onPlayerReady,
        'onStateChange': onPlayerStateChange
      }
    });
  }

  function onPlayerReady(event) {
    // Set video quality to highest available (2160p if available)
    event.target.setPlaybackQuality('hd2160');
    // Force quality if available, otherwise fallback to next highest
    setTimeout(function() {
      var quality = event.target.getPlaybackQuality();
      if (quality !== 'hd2160') {
        // Try to set to highest available quality
        event.target.setPlaybackQuality('highres');
      }
    }, 1000);
    
    // Ensure video is playing and muted
    event.target.mute();
    event.target.playVideo();
  }

  function onPlayerStateChange(event) {
    // Loop the video when it ends
    if (event.data === YT.PlayerState.ENDED) {
      event.target.playVideo();
    }
  }

  // Expose function globally for YouTube API
  window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
</script>
<% } %>
<!-- Room Details -->
<section class="page-details section-padding">
    <div class="container">
        <div class="row">
            <div class="col-lg-7 col-md-12 mb-30">
                <div class="row mb-30">
                    <div class="col-md-12">
                        <% if (stay && stay.tagline) { %>
                            <div class="section-subtitle"><%= stay.tagline %></div>
                        <% } %>
                        <% if (stay && stay.title) { %>
                            <div class="section-title"><%= stay.title %></div>
                        <% } %>
                        <% if (stay && stay.detailDescription) { %>
                            <% const paragraphs = stay.detailDescription.split('\n\n'); %>
                            <% paragraphs.forEach(paragraph => { %>
                                <p><%= paragraph %></p>
                            <% }); %>
                        <% } %>
                    </div>
                </div>
                <div class="row">
                    <% if (stay && stay.checkInOut) { %>
                        <div class="col-lg-6 col-md-12 mb-30">
                            <h5>Check-In</h5>
                            <ul class="list-unstyled page-list">
                                <li>
                                    <div class="page-list-icon"> <span class="ti-check"></span> </div>
                                    <div class="page-list-text">
                                        <p><%= stay.checkInOut.checkIn %></p>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="col-lg-6 col-md-12 mb-30">
                            <h5>Check-Out</h5>
                            <ul class="list-unstyled page-list mb-30">
                                <li>
                                    <div class="page-list-icon"> <span class="ti-check"></span> </div>
                                    <div class="page-list-text">
                                        <p><%= stay.checkInOut.checkOut %></p>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    <% } %>
                </div>
            </div>
            <div class="col-lg-4 offset-lg-1 col-md-12">
                <div class="cont">
                    <h5>Room Equipment</h5>
                    <ul class="list">
                        <% if (stay && stay.features && stay.features.length > 0) { %>
                            <% stay.features.forEach(feature => { %>
                                <li>
                                    <% if (typeof feature === 'string') { %>
                                        <span><i class="fa-regular fa-check"></i></span>
                                        <span><%= feature %></span>
                                    <% } else { %>
                                        <span><i class="<%= feature.icon %>"></i></span>
                                        <span><%= feature.text %></span>
                                    <% } %>
                                </li>
                            <% }); %>
                        <% } %>
                    </ul>
                </div>
                <% if (stay && stay.paidServices && stay.paidServices.length > 0) { %>
                    <div class="cont mt-4">
                        <h5>Paid Services</h5>
                        <ul class="list">
                            <% stay.paidServices.forEach(service => { %>
                                <li>
                                    <span><i class="fa-regular fa-circle-dollar"></i></span>
                                    <span><%= service %></span>
                                </li>
                            <% }); %>
                        </ul>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</section>
<!-- Gallery Image -->
<% if (stay && stay.detailImages && stay.detailImages.length > 0) { %>
    <section class="galleryscroll section-padding bg-darkgray">
        <div class="container-fluid p-0">
            <div class="row justify-content-center">
                <div class="col-md-12 text-center mb-20">
                    <div class="section-subtitle">Room Images</div>
                    <% if (stay && stay.title) { %>
                        <div class="section-title white"><%= stay.title %></div>
                    <% } %>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="owl-carousel owl-theme">
                        <% stay.detailImages.forEach((image) => { %>
                            <div class="item">
                                <a href="<%= image %>" title="<%= stay.title %>" class="gallery-masonry-item-img-link img-zoom">
                                    <div class="img"> <img src="<%= image %>" class="img-fluid mx-auto d-block" style="aspect-ratio: 14/9; object-fit: cover;" alt="<%= stay.title %>"> </div>
                                </a>
                            </div>
                        <% }); %>
                    </div>
                </div>
            </div>
        </div>
    </section>
<% } %>

<%- include('footer') %>
