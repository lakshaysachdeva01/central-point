<% // Function to convert a YouTube URL (watch or short form) into an embeddable URL 
function convertToEmbedUrl(url) {
    let videoId = "";
    if (url.includes("youtu.be")) {
        // Handle short URL format (e.g., https://youtu.be/Tjxx80uYyUQ)
        videoId = url.split("youtu.be/")[1]?.split("?")[0];
    } else if (url.includes("youtube.com/watch")) {
        // Handle full URL format (e.g., https://www.youtube.com/watch?v=Tjxx80uYyUQ)
        videoId = url.split("v=")[1]?.split("&")[0];
    }
    return videoId ? `https://www.youtube.com/embed/${videoId}` : "";
} %>

<section class="blog1 section-padding bg-lightbrown">
    <div class="container">
        <div class="row mb-15">
            <div class="col-md-12 text-center">
                <div class="section-subtitle">Latest News</div>
                <div class="section-title">Hotel Articles</div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <% if (blogs && blogs.length > 0) { %>
                    <% const latestBlogs = blogs.slice().reverse() %>
                    <div class="owl-carousel owl-theme home-blog-carousel" data-blog-count="<%= latestBlogs.length %>">
                        <% latestBlogs.forEach((item, index) => { %>
                            <div class="item mt-10" onclick="window.location.href='/blog/<%= item.seoDetails.slug %>'">
                                <div class="img">
                                    <% if (item?.banner?.bannerType === "VIDEO" && item?.banner?.video && item?.banner?.video !== "") { %>
                                        <!-- Render YouTube video thumbnail if the banner type is VIDEO -->
                                        <% 
                                            const embedUrl = convertToEmbedUrl(item.banner.video);
                                            let videoId = "";
                                            if (embedUrl) {
                                                // Extract video ID from embed URL
                                                const match = embedUrl.match(/embed\/([^?]+)/);
                                                videoId = match ? match[1] : "";
                                            }
                                        %>
                                        <% if (videoId) { %>
                                            <!-- YouTube thumbnail with play button overlay -->
                                            <div style="position: relative;">
                                                <img src="https://img.youtube.com/vi/<%= videoId %>/hqdefault.jpg" 
                                                     class="img-fluid" 
                                                     alt="<%= item.title %>"
                                                     style="width: 100%; height: 250px; object-fit: cover; scale: 1.2;">
                                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
                                                    <div style="width: 60px; height: 60px; background: rgba(0, 0, 0, 0.571); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="white">
                                                            <path d="M8 5v14l11-7z"/>
                                                        </svg>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } else { %>
                                            <!-- Fallback image if video ID not found -->
                                            <img src="/assets/img/blog/default-video-thumbnail.jpg" 
                                                 class="img-fluid" 
                                                 alt="<%= item.title %>">
                                        <% } %>
                                    <% } else if (item?.banner?.bannerType === "IMAGE" && item?.banner?.image) { %>
                                        <!-- Render image if the banner type is IMAGE -->
                                        <img src="<%= process.env.S3_BASE_URL + item.banner.image %>" 
                                             class="img-fluid" 
                                             alt="<%= item.title %>">
                                    <% } else { %>
                                        <!-- Default image if no banner -->
                                        <img src="/assets/img/blog/default-blog.jpg" 
                                             class="img-fluid" 
                                             alt="<%= item.title %>">
                                    <% } %>
                                    <div class="cat" style="width:fit-content"><%= item.category %></div>
                                </div>
                                <div class="cont">
                                    <h4>
                                        <a style="display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; line-clamp: 2; overflow: hidden; text-overflow: ellipsis;" 
                                           href="/blog/<%= item.seoDetails.slug %>">
                                            <%= item.title %>
                                        </a>
                                    </h4>
                                    <div style="display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; line-clamp: 3; overflow: hidden; text-overflow: ellipsis; margin-bottom: 15px;">
                                        <%- item.description.replace(/<span[^>]*>/g, '').replace(/<\/span>/g, '').replace(/\n/g, ' ') %>
                                    </div>
                                
                                </div>
                            </div>
                        <% }); %>
                    </div>
                <% } else { %>
                    <div class="col-12 text-center">
                        <p>No blog posts available.</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</section>

<script>
// Wait for custom.js to initialize, then override
setTimeout(function() {
    const homeBlogCarousel = $('.home-blog-carousel');
    if (homeBlogCarousel.length) {
        const blogCount = parseInt(homeBlogCarousel.attr('data-blog-count')) || 0;
        
        // Destroy any existing initialization from custom.js
        if (homeBlogCarousel.hasClass('owl-loaded')) {
            homeBlogCarousel.trigger('destroy.owl.carousel');
            homeBlogCarousel.removeClass('owl-loaded owl-carousel owl-theme');
            homeBlogCarousel.find('.owl-stage-outer').children().unwrap();
        }
        
        // Determine loop settings - NO LOOP when items <= visible count
        const shouldLoopDesktop = blogCount > 3;
        const shouldLoopTablet = blogCount > 2;
        const shouldLoopMobile = blogCount > 1;
        
        // Initialize carousel with loop disabled
        const carousel = homeBlogCarousel.addClass('owl-carousel owl-theme').owlCarousel({
            loop: false,
            margin: 20,
            mouseDrag: shouldLoopDesktop,
            autoplay: false,
            autoplayTimeout: 5000,
            dots: shouldLoopDesktop,
            autoplayHoverPause: true,
            nav: shouldLoopDesktop,
            navText: ["<span class='fa-light fa-angle-left'></span>", "<span class='fa-light fa-angle-right'></span>"],
            responsiveClass: true,
            responsive: {
                0: {
                    items: 1,
                    nav: false,
                    dots: shouldLoopMobile,
                    loop: false,
                    mouseDrag: shouldLoopMobile
                },
                600: {
                    items: 2,
                    nav: false,
                    dots: shouldLoopTablet,
                    loop: false,
                    mouseDrag: shouldLoopTablet
                },
                1000: {
                    items: 3,
                    loop: false,
                    nav: shouldLoopDesktop,
                    mouseDrag: shouldLoopDesktop,
                    dots: shouldLoopDesktop
                }
            }
        });
        
        // Multiple checks to remove cloned items
        function removeClones() {
            const clonedItems = homeBlogCarousel.find('.owl-item.cloned');
            if (clonedItems.length > 0) {
                clonedItems.remove();
                homeBlogCarousel.trigger('refresh.owl.carousel');
            }
        }
        
        // Remove clones immediately and after delays
        removeClones();
        setTimeout(removeClones, 100);
        setTimeout(removeClones, 300);
        setTimeout(removeClones, 500);
        
        // Also remove clones on carousel events
        homeBlogCarousel.on('initialized.owl.carousel', removeClones);
        homeBlogCarousel.on('refreshed.owl.carousel', removeClones);
    }
}, 100);
</script>

<!-- Add some CSS for the YouTube thumbnail styling -->
<style>
   .blog1 .img {
        position: relative;
        overflow: hidden;
    }
    
    .blog1 .cat {
        position: absolute;
        top: 15px;
        left: 15px;
        background: #ff0000;
        color: white;
        padding: 5px 15px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: 600;
        z-index: 2;
    }
    
    .blog1 .item {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
        cursor: pointer;
        height: 100%;
    }
    
    .blog1 .item:hover {
        transform: translateY(-5px);
    }
    
    .blog1 .cont {
        padding: 20px;
    }
    
    .blog1 .img img {
        width: 100%;
        height: 250px;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    
    .blog1 .item:hover .img img {
        transform: scale(1.05);
    }
</style>
